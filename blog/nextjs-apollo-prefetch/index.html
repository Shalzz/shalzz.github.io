<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()"/>

    <title>
  Prefetching Data with Next.js and Apollo
</title>

    
    <meta name="description" content="
Update: My pull requests implementing the techniques discussed here were merged into the zeit&#x2F;next.js with-data-prefetch and with-apollo examples. You can easily combine the various examples (including the above two) to achieve your desired functionality.

For most modern web apps, network speed and latency is still the biggest constraint for high performance and great UX. Universally rendered Isomorphic applications do a great job to solve that to some extent without sacrificing interactivity by processing the complete DOM of the first request on the server and subsequent requests on the client. But there is a lot more we can do.
">

    
        <meta name="keywords" content="nextjs, apollo, apollo-server, next.js, prefetch, performance, graphql, react, react.js, apollo-client">
    


    
        <meta name="author" content="Shaleen Jain">

        <link rel="author" href="https:&#x2F;&#x2F;twitter.com&#x2F;shalzzj">
        
            <link href="https:&#x2F;&#x2F;shaleenjain.com&#x2F;blog&#x2F;nextjs-apollo-prefetch&#x2F;" rel="canonical">
        
         <link rel="alternate" type="application/atom+xml" title="RSS" href="https://shaleenjain.com/atom.xml">
    

    
    
        <meta name="twitter:site" content="@shalzzj">
        <meta name="twitter:creator" content="@shalzzj">

        <meta property="og:type" content="article">
        
            <meta property="og:url" content="https:&#x2F;&#x2F;shaleenjain.com&#x2F;blog&#x2F;nextjs-apollo-prefetch&#x2F;">
        

        
        <meta property="og:description" content="Personal and technical musings">
        
    
    <meta name="twitter:title" content="Prefetching Data with Next.js and Apollo &mdash; Shaleen Jain">
    <meta property="og:title" content="Prefetching Data with Next.js and Apollo">


    
    


    
        <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
        <link rel="manifest" href="/icons/manifest.json">
        <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
        <link rel="shortcut icon" href="/icons/favicon.ico">
        <meta name="msapplication-config" content="/icons/browserconfig.xml">
        <meta name="theme-color" content="#ffffff">
    

    

    
        <style>
            /*! normalize.css v3.0.2 | MIT License | git.io/normalize */html{font-family:"sans-serif";-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{font-size:2em;margin:0.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:0px}hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid #c0c0c0;margin:0 2px;padding:0.35em 0.625em 0.75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}html{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}*,*:before,*:after{box-sizing:inherit}.image-row{display:flex;flex-flow:row wrap;align-items:center;padding:0 4px}.image-column{flex:50%;max-width:50%;padding:0 4px;border-radius:8px;width:100%;height:auto}@media screen and (max-width: 42em){.image-column{flex:100%;max-width:100%}}.text-center{text-align:center}.text-right{text-align:right}.fa-social-icons{font-size:2rem;margin-top:-1rem}.fa-social-icons a{border:0;margin-right:0.1rem}.fa-social-icons a:last-child{margin-right:0}.masthead,.content,.footer{max-width:42em;margin-left:auto;margin-right:auto}.masthead:after,.post:after,.related:after,.recent:after,.page:after,.comments:after,.index:after{display:block;content:"";width:150px;height:1px;margin:2rem auto;background-color:#c4c4c4}.related .related-title,.related .recent-title,.recent .related-title,.recent .recent-title{margin-top:0}.masthead{margin-bottom:2rem;padding-top:1rem;text-align:right}.masthead a{color:#111}.masthead .masthead-title{margin:0;padding:0;float:left}.masthead .masthead-title a{text-decoration:none;border:0}.masthead .masthead-nav{display:inline-block;padding-left:0;margin-bottom:0}.masthead .masthead-nav a{text-decoration:none;border:0}.masthead .masthead-nav a+a{margin-left:0.6rem}.footer{margin-bottom:1rem;text-align:center}.footer a[rel="license"]:first-child{display:inline-block;margin:0;padding:0;border:0;text-decoration:none}.footer .icon-square{color:transparent}.footer .icon-square:hover{color:#252525}.footer .fa-stack-1x{color:black}.footer p>span{font-size:110%}.footer p>span a{padding:2px;border:0}.footer p>span i:hover{color:white}.footer p p:last-child{margin-bottom:0}.posts{padding-bottom:1rem}.posts .posts-item{margin-bottom:1rem}@media (min-width: 42em){.posts .posts-item{margin-bottom:0.2rem}}.posts a{border:0}.posts time{display:block;color:#848484}@media (min-width: 42em){.posts time{margin-top:2px;float:right}}.next,.previous{font-weight:600;font-size:20px;transition:transform 0.3s ease-out}.next{float:right}.next:hover{transform:translateX(4px)}.previous{float:left}.previous:hover{transform:translateX(-4px)}html,body{margin:0}html{font-family:"Lora","sans-serif";font-size:18px;line-height:1.6}@media (min-width: 42em){html{font-size:20px}}body{padding:2rem 1.5rem;color:#444;background-color:#fff;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a{color:#afd700;text-decoration:none;border-bottom:1px solid #afd700}a:hover,a:focus{background-color:#afd700;color:white}a strong{color:inherit}img{display:block;max-width:100%;margin:0 0 1rem;border-radius:5px}table{margin-bottom:1rem;width:100%;font-size:85%;border:1px solid #c4c4c4;border-collapse:collapse}.js-file-line-container td{border:none}td,th{padding:.25rem .5rem;border:1px solid #c4c4c4}th{text-align:left}tbody tr:nth-child(even) td,tbody tr:nth-child(even) th{background-color:#fff}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#fafafa}

        </style>
    

    
      <style>
        /* latin */
        @font-face {
          font-family: 'Lora';
          font-style: italic;
          font-weight: 400;
          font-display: swap;
          src: url("/fonts/0QI8MX1D_JOuMw_hLdO6T2wV9KnW-MoFoq92nA.woff2") format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        /* latin */
        @font-face {
          font-family: 'Lora';
          font-style: normal;
          font-weight: 400;
          font-display: swap;
          src: url("/fonts/0QI6MX1D_JOuGQbT0gvTJPa787weuxJBkq0.woff2") format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
        /* latin */
        @font-face {
          font-family: 'Lora';
          font-style: normal;
          font-weight: 700;
          font-display: swap;
          src: url("/fonts/0QI6MX1D_JOuGQbT0gvTJPa787z5vBJBkq0.woff2") format('woff2');
          unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
      </style>
    
  </head>

  <body>
    
        <link rel="stylesheet" href="/style.css">
    

    
        <header class="masthead">
          <h3 class="masthead-title">
            <a href="/">Shaleen Jain</a>
          </h3>
          <nav class="masthead-nav">
            
            <a href="&#x2F;blog" class="nav-item">Blog</a>
            
          </nav>
        </header>
    


    <main class="content">
        

<article class="post">
  <header class="post-header">
    <time datetime="2018-01-08" class="post-date">
        08 Jan 2018
    </time>
        
        <small>
            Â· 
    <span class="reading-time" title="Estimated read time">
      
        3 min read
      
    </span>

        </small>
    <h1 class="post-title">Prefetching Data with Next.js and Apollo</h1>
  </header>

  <blockquote>
<p>Update: My pull requests implementing the techniques discussed here were merged into the zeit/next.js <a rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/zeit/next.js/tree/canary/examples/with-data-prefetch">with-data-prefetch</a> and <a rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/zeit/next.js/tree/canary/examples/with-apollo">with-apollo</a> examples. You can easily combine the various examples (including the above two) to achieve your desired functionality.</p>
</blockquote>
<p>For most modern web apps, network speed and latency is still the biggest constraint for high performance and great UX. Universally rendered Isomorphic applications do a great job to solve that to some extent without sacrificing interactivity by processing the complete DOM of the first request on the server and subsequent requests on the client. But there is a lot more we can do.</p>
<span id="continue-reading"></span>
<p>Modern web apps already have their core application logic on the client by the time the first request completes. From there on anticipating the user action and selectively prefetching the data can lead to great performance and UX improvements.</p>
<p><a rel="noopener nofollow noreferrer" target="_blank" href="https://www.apollographql.com/client/">Apollo</a> and <a rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/zeit/next.js">Next</a> is the stack of our choice, having the necessary capabilities, to demonstrate our concept.</p>
<p>Adam Sofferâ€™s <a rel="noopener nofollow noreferrer" target="_blank" href="https://dev-blog.apollodata.com/whats-next-js-for-apollo-e4dfe835d070">introduction</a> summarizes <a rel="noopener nofollow noreferrer" target="_blank" href="https://www.apollographql.com/client/">Apollo</a> and <a rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/zeit/next.js">Next</a> with their concerns perfectly:</p>
<blockquote>
<p>Apollo is a GraphQL client thatâ€™s concerned exclusively with the data layer of our application; it cares about efficiently fetching our data. Next, on the other hand, is a minimalistic framework for server-rendered React applications thatâ€™s concerned exclusively with the UI layer of our application; it cares about efficiently rendering our UI.</p>
</blockquote>
<h2 id="tying-together-next-js-and-apollo"><a class="zola-anchor" href="#tying-together-next-js-and-apollo" aria-label="Anchor link for: tying-together-next-js-and-apollo">ðŸ”—</a>
Tying together Next.js and Apollo</h2>
<p>Next has a unique way of loading data, every page has a lifecycle hook function <code>getInitialProps</code> which is called while loading on the client as well as the server. This is a very nice separation of our data logic from the UI logic and is what enables us to use the full power of Apollo and Next as both of these frameworks make no assumptions about each others layer and provides the perfect abstraction to connects these two layers.</p>
<p>Apollo clientâ€™s react library <a rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/apollographql/react-apollo">react-apollo</a> provides a helper function <code>getDataFromTree</code> which recursively traverses the supplied React component and executes every <code>graphql()</code> query it finds, storing the result in its local cache (configured by us).</p>
<p>The excellent <a rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/zeit/next.js/tree/canary/examples/with-apollo">example</a> from the Next.js repo shows how we can combine these two functionalities by creating a HOC which wraps <code>getDataFromTree</code> within <code>getInitialProps</code> and returning the cached data as a plain Javascript Object</p>
<p>Here we make sure to use <code>getDataFromTree</code> on both the client and for SSR, altering the example like so:</p>
<pre style="background-color:#fdf6e3;">
<code class="language-javascript" data-lang="javascript"><span style="color:#cb4b16;">import </span><span style="color:#268bd2;">React </span><span style="color:#cb4b16;">from </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">react</span><span style="color:#839496;">&#39;
</span><span style="color:#cb4b16;">import </span><span style="color:#268bd2;">PropTypes </span><span style="color:#cb4b16;">from </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">prop-types</span><span style="color:#839496;">&#39;
</span><span style="color:#cb4b16;">import </span><span style="color:#657b83;">{ </span><span style="color:#268bd2;">ApolloProvider</span><span style="color:#657b83;">, </span><span style="color:#268bd2;">getDataFromTree </span><span style="color:#657b83;">} </span><span style="color:#cb4b16;">from </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">react-apollo</span><span style="color:#839496;">&#39;
</span><span style="color:#cb4b16;">import </span><span style="color:#268bd2;">Head </span><span style="color:#cb4b16;">from </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">next/head</span><span style="color:#839496;">&#39;

</span><span style="color:#cb4b16;">import </span><span style="color:#268bd2;">initApollo </span><span style="color:#cb4b16;">from </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">./initApollo</span><span style="color:#839496;">&#39;

</span><span style="color:#859900;">export default </span><span style="color:#268bd2;">ComposedComponent =&gt; </span><span style="color:#657b83;">{
  </span><span style="color:#859900;">return </span><span style="color:#268bd2;">class </span><span style="color:#b58900;">WithData </span><span style="color:#586e75;">extends </span><span style="color:#b58900;">React</span><span style="color:#657b83;">.</span><span style="color:#268bd2;">Component </span><span style="color:#657b83;">{
    </span><span style="color:#586e75;">static </span><span style="color:#268bd2;">displayName </span><span style="color:#657b83;">= </span><span style="color:#839496;">`</span><span style="color:#2aa198;">WithData(${</span><span style="color:#b58900;">getComponentDisplayName</span><span style="color:#657b83;">(
      </span><span style="color:#268bd2;">ComposedComponent
    </span><span style="color:#657b83;">)</span><span style="color:#2aa198;">})</span><span style="color:#839496;">`
    </span><span style="color:#586e75;">static </span><span style="color:#268bd2;">propTypes </span><span style="color:#657b83;">= {
      serverState: </span><span style="color:#268bd2;">PropTypes</span><span style="color:#657b83;">.</span><span style="color:#859900;">object</span><span style="color:#657b83;">.</span><span style="color:#268bd2;">isRequired
    </span><span style="color:#657b83;">}

    </span><span style="color:#586e75;">static async </span><span style="color:#b58900;">getInitialProps</span><span style="color:#657b83;">(</span><span style="color:#268bd2;">ctx</span><span style="color:#657b83;">) {
      </span><span style="color:#93a1a1;">// Initial serverState with apollo (empty)
      </span><span style="color:#268bd2;">let serverState

      </span><span style="color:#93a1a1;">// Evaluate the composed component&#39;s getInitialProps()
      </span><span style="color:#268bd2;">let composedInitialProps </span><span style="color:#657b83;">= {}
      </span><span style="color:#859900;">if </span><span style="color:#657b83;">(</span><span style="color:#268bd2;">ComposedComponent</span><span style="color:#657b83;">.</span><span style="color:#268bd2;">getInitialProps</span><span style="color:#657b83;">) {
        </span><span style="color:#268bd2;">composedInitialProps </span><span style="color:#657b83;">= </span><span style="color:#859900;">await </span><span style="color:#268bd2;">ComposedComponent</span><span style="color:#657b83;">.</span><span style="color:#b58900;">getInitialProps</span><span style="color:#657b83;">(</span><span style="color:#268bd2;">ctx</span><span style="color:#657b83;">)
      }

      </span><span style="color:#93a1a1;">// Run all GraphQL queries in the component tree
      // and extract the resulting data
      </span><span style="color:#268bd2;">const apollo </span><span style="color:#657b83;">= </span><span style="color:#b58900;">initApollo</span><span style="color:#657b83;">();

      </span><span style="color:#859900;">try </span><span style="color:#657b83;">{
        </span><span style="color:#93a1a1;">// Run all GraphQL queries
        </span><span style="color:#859900;">await </span><span style="color:#b58900;">getDataFromTree</span><span style="color:#657b83;">(
          &lt;</span><span style="color:#b58900;">ComposedComponent ctx</span><span style="color:#657b83;">={</span><span style="color:#268bd2;">ctx</span><span style="color:#657b83;">} {</span><span style="color:#859900;">...</span><span style="color:#b58900;">composedInitialProps</span><span style="color:#657b83;">} /&gt;,
          {
            router: {
              asPath: </span><span style="color:#268bd2;">ctx</span><span style="color:#657b83;">.</span><span style="color:#268bd2;">asPath</span><span style="color:#657b83;">,
              pathname: </span><span style="color:#268bd2;">ctx</span><span style="color:#657b83;">.</span><span style="color:#859900;">pathname</span><span style="color:#657b83;">,
              query: </span><span style="color:#268bd2;">ctx</span><span style="color:#657b83;">.</span><span style="color:#268bd2;">query
            </span><span style="color:#657b83;">},
            client: </span><span style="color:#268bd2;">apollo</span><span style="color:#657b83;">,
          }
        )
      } </span><span style="color:#859900;">catch </span><span style="color:#657b83;">(</span><span style="color:#268bd2;">error</span><span style="color:#657b83;">) {
        </span><span style="color:#93a1a1;">// Prevent Apollo Client GraphQL errors from crashing SSR.
        // Handle them in components via the data.error prop:
        // https://www.apollographql.com/docs/react/basics/queries.html#graphql-query-data-error
      </span><span style="color:#657b83;">}

      </span><span style="color:#859900;">if </span><span style="color:#657b83;">(</span><span style="color:#859900;">!process</span><span style="color:#657b83;">.</span><span style="color:#268bd2;">browser</span><span style="color:#657b83;">) {
        </span><span style="color:#93a1a1;">// getDataFromTree does not call componentWillUnmount
        // head side effect therefore need to be cleared manually
        </span><span style="color:#268bd2;">Head</span><span style="color:#657b83;">.</span><span style="color:#b58900;">rewind</span><span style="color:#657b83;">()
      }

      </span><span style="color:#93a1a1;">// Extract query data from the Apollo store
      </span><span style="color:#268bd2;">serverState </span><span style="color:#657b83;">= {
        apollo: {
          data: </span><span style="color:#268bd2;">apollo</span><span style="color:#657b83;">.</span><span style="color:#268bd2;">cache</span><span style="color:#657b83;">.</span><span style="color:#b58900;">extract</span><span style="color:#657b83;">()
        }
      }

      </span><span style="color:#859900;">return </span><span style="color:#657b83;">{
        </span><span style="color:#268bd2;">serverState</span><span style="color:#657b83;">,
        </span><span style="color:#859900;">...</span><span style="color:#268bd2;">composedInitialProps
      </span><span style="color:#657b83;">}
    }

    </span><span style="color:#268bd2;">constructor</span><span style="color:#657b83;">(</span><span style="color:#268bd2;">props</span><span style="color:#657b83;">) {
      </span><span style="color:#d33682;">super</span><span style="color:#657b83;">(</span><span style="color:#268bd2;">props</span><span style="color:#657b83;">)
      </span><span style="color:#d33682;">this</span><span style="color:#657b83;">.</span><span style="color:#268bd2;">apollo </span><span style="color:#657b83;">= </span><span style="color:#b58900;">initApollo</span><span style="color:#657b83;">(</span><span style="color:#d33682;">this</span><span style="color:#657b83;">.</span><span style="color:#268bd2;">props</span><span style="color:#657b83;">.</span><span style="color:#268bd2;">serverState</span><span style="color:#657b83;">.</span><span style="color:#268bd2;">apollo</span><span style="color:#657b83;">.</span><span style="color:#859900;">data</span><span style="color:#657b83;">)
    }

    </span><span style="color:#b58900;">render</span><span style="color:#657b83;">() {
      </span><span style="color:#859900;">return </span><span style="color:#657b83;">(
        &lt;</span><span style="color:#b58900;">ApolloProvider client</span><span style="color:#657b83;">={</span><span style="color:#b58900;">this</span><span style="color:#657b83;">.</span><span style="color:#268bd2;">apollo</span><span style="color:#657b83;">}&gt;
          &lt;</span><span style="color:#b58900;">ComposedComponent </span><span style="color:#657b83;">{</span><span style="color:#859900;">...</span><span style="color:#b58900;">this</span><span style="color:#657b83;">.</span><span style="color:#b58900;">props</span><span style="color:#657b83;">} /&gt;
        &lt;/</span><span style="color:#b58900;">ApolloProvider</span><span style="color:#657b83;">&gt;
      )
    }
  }
}
</span></code></pre><h2 id="prefetching-data"><a class="zola-anchor" href="#prefetching-data" aria-label="Anchor link for: prefetching-data">ðŸ”—</a>
Prefetching Data</h2>
<p>Next has <a rel="noopener nofollow noreferrer" target="_blank" href="https://github.com/zeit/next.js#with-link-1">in-built</a> support for prefetching pages by adding the <code>prefetch</code> prop to the <code>&lt;Link&gt;</code> component or imperatively calling <code>Router.prefetch('/dynamic')}</code>. However this fetches the pageâ€™s JS code but not its data/initial props.</p>
<p>This results in instant page loads but, some would argue even worse, a loading indicator shown for however long it takes to get the relevant page data from your API.</p>
<p>Since we know our stack we can optimise performance using that knowledge. We know that with every call to <code>getInitialProps</code> of a component wrapped in our <code>WithData</code> HOC, our queries are cached in the local ApolloClient store. With that all we have to do is get a reference to our top level page component and manually call its <code>getInitialProps</code> method!</p>
<pre style="background-color:#fdf6e3;">
<code class="language-javascript" data-lang="javascript"><span style="color:#cb4b16;">import </span><span style="color:#268bd2;">Router </span><span style="color:#cb4b16;">from </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">next/router</span><span style="color:#839496;">&#39;
</span><span style="color:#cb4b16;">import </span><span style="color:#657b83;">{ </span><span style="color:#268bd2;">format</span><span style="color:#657b83;">, </span><span style="color:#268bd2;">resolve</span><span style="color:#657b83;">, </span><span style="color:#268bd2;">parse </span><span style="color:#657b83;">} </span><span style="color:#cb4b16;">from </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">url</span><span style="color:#839496;">&#39;

</span><span style="color:#859900;">export default </span><span style="color:#b58900;">prefetch </span><span style="color:#657b83;">= </span><span style="color:#586e75;">async </span><span style="color:#657b83;">(</span><span style="color:#268bd2;">href</span><span style="color:#657b83;">) </span><span style="color:#268bd2;">=&gt; </span><span style="color:#657b83;">{
  </span><span style="color:#93a1a1;">// if  we&#39;re running server side do nothing
  </span><span style="color:#859900;">if </span><span style="color:#657b83;">(</span><span style="color:#859900;">typeof window </span><span style="color:#657b83;">=== </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">undefined</span><span style="color:#839496;">&#39;</span><span style="color:#657b83;">) </span><span style="color:#859900;">return

  </span><span style="color:#268bd2;">const url </span><span style="color:#657b83;">=
    </span><span style="color:#859900;">typeof </span><span style="color:#268bd2;">href </span><span style="color:#657b83;">!== </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">string</span><span style="color:#839496;">&#39;
      </span><span style="color:#859900;">? </span><span style="color:#b58900;">format</span><span style="color:#657b83;">(</span><span style="color:#268bd2;">href</span><span style="color:#657b83;">)
      </span><span style="color:#859900;">: </span><span style="color:#268bd2;">href

  const </span><span style="color:#657b83;">{ </span><span style="color:#268bd2;">pathname </span><span style="color:#657b83;">} = </span><span style="color:#859900;">window</span><span style="color:#657b83;">.</span><span style="color:#859900;">location

  </span><span style="color:#268bd2;">const parsedHref </span><span style="color:#657b83;">= </span><span style="color:#b58900;">resolve</span><span style="color:#657b83;">(</span><span style="color:#268bd2;">pathname</span><span style="color:#657b83;">, </span><span style="color:#268bd2;">url</span><span style="color:#657b83;">)

  </span><span style="color:#268bd2;">const </span><span style="color:#657b83;">{ </span><span style="color:#268bd2;">query </span><span style="color:#657b83;">} =
    </span><span style="color:#859900;">typeof </span><span style="color:#268bd2;">href </span><span style="color:#657b83;">!== </span><span style="color:#839496;">&#39;</span><span style="color:#2aa198;">string</span><span style="color:#839496;">&#39;
      </span><span style="color:#859900;">? </span><span style="color:#268bd2;">href
      </span><span style="color:#859900;">: </span><span style="color:#b58900;">parse</span><span style="color:#657b83;">(</span><span style="color:#268bd2;">url</span><span style="color:#657b83;">, </span><span style="color:#b58900;">true</span><span style="color:#657b83;">);

  </span><span style="color:#93a1a1;">// get component reference
  </span><span style="color:#268bd2;">const Component </span><span style="color:#657b83;">= </span><span style="color:#859900;">await </span><span style="color:#268bd2;">Router</span><span style="color:#657b83;">.</span><span style="color:#b58900;">prefetch</span><span style="color:#657b83;">(</span><span style="color:#268bd2;">parsedHref</span><span style="color:#657b83;">)

  </span><span style="color:#93a1a1;">// fetch the component props
  // and cache locally, handled within getInitialProps
  </span><span style="color:#859900;">if </span><span style="color:#657b83;">(</span><span style="color:#268bd2;">Component </span><span style="color:#859900;">&amp;&amp; </span><span style="color:#268bd2;">Component</span><span style="color:#657b83;">.</span><span style="color:#268bd2;">getInitialProps</span><span style="color:#657b83;">) {
    </span><span style="color:#268bd2;">const ctx </span><span style="color:#657b83;">= { pathname: </span><span style="color:#268bd2;">href</span><span style="color:#657b83;">, </span><span style="color:#268bd2;">query</span><span style="color:#657b83;">, isVirtualCall: </span><span style="color:#b58900;">true </span><span style="color:#657b83;">}
    </span><span style="color:#859900;">await </span><span style="color:#268bd2;">Component</span><span style="color:#657b83;">.</span><span style="color:#b58900;">getInitialProps</span><span style="color:#657b83;">(</span><span style="color:#268bd2;">ctx</span><span style="color:#657b83;">)
  }
}
</span></code></pre>
<p>We can then call this throughout our application, like for example:
<code>&lt;a onMouseOver={() =&gt; prefetch(&quot;/product?sku=0001&quot;)}&gt;</code></p>
<p>This will load not only our product.js page but also all the specific graphql queries into the ApolloClient store.</p>

</article>


<h3>Subscribe to my Newsletter</h3>
<div>
  Liked this article? Share this article with others and subscribe to my newsletter
  to know about the next cool thing I'm working on or launching.
</div>
<br/>

<!-- Begin Mailchimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
<style type="text/css">
	#mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
	/* MailChimp Form Embed Code - Classic - 12/17/2015 v10.7 */
	#mc_embed_signup form {display:block; position:relative; text-align:left; padding:0 0 3% 0;}
	#mc_embed_signup h2 {font-weight:bold; padding:0; margin:15px 0; font-size:1.4em;}
	#mc_embed_signup input {border: 1px solid #ABB0B2; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px;}
	#mc_embed_signup input[type=checkbox]{-webkit-appearance:checkbox;}
	#mc_embed_signup input[type=radio]{-webkit-appearance:radio;}
	#mc_embed_signup input:focus {border-color:#333;}
	#mc_embed_signup .button {clear:both; background-color: #aaa; border: 0 none; border-radius:4px; transition: all 0.23s ease-in-out 0s; color: #FFFFFF; cursor: pointer; display: inline-block; font-size:15px; font-weight: normal; height: 32px; line-height: 32px; margin: 0 5px 10px 0; padding: 0 22px; text-align: center; text-decoration: none; vertical-align: top; white-space: nowrap; width: auto;}
	#mc_embed_signup .button:hover {background-color:#777;}
	#mc_embed_signup .small-meta {font-size: 11px;}
	#mc_embed_signup .nowrap {white-space:nowrap;}

	#mc_embed_signup .mc-field-group {clear:left; position:relative; width:96%; padding: 0.5%; min-height:50px;}
	#mc_embed_signup .size1of2 {clear:none; float:left; display:inline-block; width:46%; margin-right:4%;}
	* html #mc_embed_signup .size1of2 {margin-right:2%; /* Fix for IE6 double margins. */}
	#mc_embed_signup .mc-field-group label {display:block; margin-bottom:3px;}
	#mc_embed_signup .mc-field-group input {display:inline; width:100%; padding:8px 0; text-indent:2%;}
	#mc_embed_signup .mc-field-group select {display:inline-block; width:99%; padding:5px 0; margin-bottom:2px;}

	#mc_embed_signup .datefield, #mc_embed_signup .phonefield-us{padding:5px 0;}
	#mc_embed_signup .datefield input, #mc_embed_signup .phonefield-us input{display:inline; width:60px; margin:0 2px; letter-spacing:1px; text-align:center; padding:5px 0 2px 0;}
	#mc_embed_signup .phonefield-us .phonearea input, #mc_embed_signup .phonefield-us .phonedetail1 input{width:40px;}
	#mc_embed_signup .datefield .monthfield input, #mc_embed_signup .datefield .dayfield input{width:30px;}
	#mc_embed_signup .datefield label, #mc_embed_signup .phonefield-us label{display:none;}

	#mc_embed_signup .asterisk {color:#e85c41; font-size:150%; font-weight:normal; position:relative; top:5px;}     
	#mc_embed_signup .mce-submit {padding: 0.5%;}
	#mc_embed_signup_scroll {display: flex; justify-items; space-around;}

	#mc_embed_signup .mc-field-group.input-group ul {margin:0; padding:5px 0; list-style:none;}
	#mc_embed_signup .mc-field-group.input-group ul li {display:block; padding:3px 0; margin:0;}
	#mc_embed_signup .mc-field-group.input-group label {display:inline;}
	#mc_embed_signup .mc-field-group.input-group input {display:inline; width:auto; border:none;}

	#mc_embed_signup div#mce-responses {clear: both;}
	#mc_embed_signup div.response {margin:1em 0; padding:1em .5em .5em 0; font-weight:bold; float:left; top:-1.5em; z-index:1; width:80%;}
	#mc_embed_signup #mce-error-response {display:none;}
	#mc_embed_signup #mce-success-response {color:#529214; display:none;}
	#mc_embed_signup label.error {display:block; float:none; width:auto; margin-left:1.05em; text-align:left; padding:.5em 0;}

	#mc-embedded-subscribe {clear:both; width:auto; display:block; margin:1em 0 1em 5%;}
	#mc_embed_signup #num-subscribers {font-size:1.1em;}
	#mc_embed_signup #num-subscribers span {padding:.5em; border:1px solid #ccc; margin-right:.5em; font-weight:bold;}

	#mc_embed_signup #mc-embedded-subscribe-form div.mce_inline_error {display:inline-block; margin:2px 0 1em 0; padding:5px 10px; background-color:rgba(255,255,255,0.85); -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; font-size:14px; font-weight:normal; z-index:1; color:#e85c41;}
	#mc_embed_signup #mc-embedded-subscribe-form input.mce_inline_error {border:2px solid #e85c41;}
	/* Add your own Mailchimp form style overrides in your site stylesheet or in this style block.
	   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
<div id="mc_embed_signup">
<form action="https://shaleenjain.us1.list-manage.com/subscribe/post?u=1eaa5ecf0b59e6a364a3c9c1a&amp;id=dbd95a64e5" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<div class="mc-field-group">
		<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
	</div>
	<!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    	<div style="position: absolute; left: -5000px;" aria-hidden="true">
		<input type="text" name="b_1eaa5ecf0b59e6a364a3c9c1a_dbd95a64e5" tabindex="-1" value="">
	</div>
	<div class="mce-submit">
		<input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
	</div>
    </div>
	<div id="mce-responses">
		<div class="response" id="mce-error-response"></div>
		<div class="response" id="mce-success-response"></div>
	</div>
</form>
</div>
<script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';fnames[3]='ADDRESS';ftypes[3]='address';fnames[4]='PHONE';ftypes[4]='phone';fnames[5]='BIRTHDAY';ftypes[5]='birthday';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
<!--End mc_embed_signup-->




  <p>Got any questions or comments? Drop me a message on <a href="https:&#x2F;&#x2F;twitter.com&#x2F;shalzzj" rel="nofollow">Twitter @shalzzj</a></p>





    </main>

    
        <footer class="footer">
          <p><small>
            This work is licensed under the <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
            CC BY-SA 4.0</a> license.
          <br/>
          <a href="/atom.xml">RSS Feed</a> â€¢
          <a href="/subscribe">Subscribe</a>!
          </small></p>
        </footer>
    

    
<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "95f9368e22cc4457b759a170492a2fd0"}'></script>


  </body>
</html>
